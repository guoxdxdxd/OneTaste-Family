# 部署文档

## 环境要求

### 开发环境
- Go 1.21+
- Node.js 18+
- Python 3.9+
- PostgreSQL 14+
- Redis 6.0+（用于缓存和会话）

### 生产环境
- 服务器：Linux (Ubuntu 20.04+ 或 CentOS 7+)
- 容器化：Docker 20.10+ 和 Docker Compose 2.0+
- 反向代理：Nginx 1.20+

## 项目结构

```
OneTasteFamily/
├── backend/              # Go后端服务
├── frontend/
│   ├── admin/          # 管理后台（Vue）
│   └── miniapp/        # 小程序（Vue）
├── ai-service/          # Python AI服务
├── docker/             # Docker配置
│   ├── docker-compose.yml
│   └── nginx.conf
└── docs/               # 文档
```

## 部署步骤

### 1. 后端服务部署（Go）

#### 1.1 编译
```bash
cd backend
go mod download
go build -o app cmd/main.go
```

#### 1.2 配置文件
创建 `config/config.yaml`:
```yaml
server:
  port: 8080
  mode: release

database:
  host: localhost
  port: 5432
  user: postgres
  password: your_password
  dbname: onetaste_family
  sslmode: disable

redis:
  host: localhost
  port: 6379
  password: ""
  db: 0

jwt:
  secret: your_jwt_secret_key
  expires: 7200

ai_service:
  url: http://ai-service:8000
  timeout: 30

upload:
  path: ./uploads
  max_size: 10485760  # 10MB
```

#### 1.3 运行
```bash
./app -config config/config.yaml
```

### 2. AI服务部署（Python）

#### 2.1 安装依赖
```bash
cd ai-service
pip install -r requirements.txt
```

#### 2.2 配置文件
创建 `.env`:
```env
OPENAI_API_KEY=your_api_key
BAIDU_ASR_API_KEY=your_baidu_key
BAIDU_ASR_SECRET_KEY=your_baidu_secret
MODEL_NAME=gpt-3.5-turbo
```

#### 2.3 运行
```bash
uvicorn app.main:app --host 0.0.0.0 --port 8000
```

### 3. 前端部署（Vue）

#### 3.1 安装依赖
```bash
cd frontend/admin
npm install
```

#### 3.2 构建
```bash
npm run build
```

#### 3.3 部署
将 `dist` 目录部署到 Nginx 或静态文件服务器

### 4. Docker部署（推荐）

#### 4.1 创建 docker-compose.yml
```yaml
version: '3.8'

services:
  postgres:
    image: postgres:14-alpine
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: your_password
      POSTGRES_DB: onetaste_family
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"

  backend:
    build: ./backend
    ports:
      - "8080:8080"
    depends_on:
      - postgres
      - redis
    environment:
      DB_HOST: postgres
      REDIS_HOST: redis

  ai-service:
    build: ./ai-service
    ports:
      - "8000:8000"
    environment:
      OPENAI_API_KEY: ${OPENAI_API_KEY}

  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./docker/nginx.conf:/etc/nginx/nginx.conf
      - ./frontend/admin/dist:/usr/share/nginx/html/admin
    depends_on:
      - backend
      - ai-service

volumes:
  postgres_data:
```

#### 4.2 启动服务
```bash
docker-compose up -d
```

### 5. Nginx配置

```nginx
upstream backend {
    server backend:8080;
}

upstream ai-service {
    server ai-service:8000;
}

server {
    listen 80;
    server_name api.onetastefamily.com;

    location /api/ {
        proxy_pass http://backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}

server {
    listen 80;
    server_name admin.onetastefamily.com;

    root /usr/share/nginx/html/admin;
    index index.html;

    location / {
        try_files $uri $uri/ /index.html;
    }
}

server {
    listen 80;
    server_name ai.onetastefamily.com;

    location / {
        proxy_pass http://ai-service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

## 环境变量配置

### 后端环境变量
- `DB_HOST`: 数据库地址
- `DB_PORT`: 数据库端口
- `DB_USER`: 数据库用户名
- `DB_PASSWORD`: 数据库密码
- `DB_NAME`: 数据库名称
- `REDIS_HOST`: Redis地址
- `JWT_SECRET`: JWT密钥
- `AI_SERVICE_URL`: AI服务地址

### AI服务环境变量
- `OPENAI_API_KEY`: OpenAI API密钥
- `BAIDU_ASR_API_KEY`: 百度语音识别API Key
- `BAIDU_ASR_SECRET_KEY`: 百度语音识别Secret Key
- `MODEL_NAME`: 使用的模型名称

## 数据库初始化

### 1. 创建数据库
```sql
CREATE DATABASE onetaste_family;
```

### 2. 执行迁移脚本
```bash
# 使用迁移工具执行SQL脚本
migrate -path ./migrations -database "postgres://user:password@localhost:5432/onetaste_family?sslmode=disable" up
```

## 监控和日志

### 日志配置
- 后端日志：`logs/backend.log`
- AI服务日志：`logs/ai-service.log`
- Nginx日志：`/var/log/nginx/`

### 监控指标
- 服务健康检查：`/health`
- 接口响应时间
- 数据库连接池状态
- Redis连接状态
- AI服务调用次数和成功率

## 安全配置

### 1. HTTPS配置
使用 Let's Encrypt 免费SSL证书：
```bash
certbot --nginx -d api.onetastefamily.com
```

### 2. 防火墙配置
```bash
# 只开放必要端口
ufw allow 22    # SSH
ufw allow 80    # HTTP
ufw allow 443   # HTTPS
ufw enable
```

### 3. 数据库安全
- 使用强密码
- 限制数据库访问IP
- 定期备份数据

## 备份策略

### 数据库备份
```bash
# 每天凌晨2点执行全量备份
0 2 * * * pg_dump -U postgres -d onetaste_family -F c -f /backup/db_$(date +\%Y\%m\%d).dump
```

### 文件备份
```bash
# 备份上传的文件
tar -czf /backup/uploads_$(date +\%Y\%m\%d).tar.gz /app/uploads
```

## 性能优化

### 1. 数据库优化
- 添加适当的索引
- 使用连接池
- 定期优化表

### 2. 缓存策略
- 使用Redis缓存热点数据
- 缓存用户信息、家庭信息
- 缓存AI分析结果（短期）

### 3. CDN配置
- 静态资源使用CDN
- 图片使用CDN加速

## 故障排查

### 常见问题

1. **服务无法启动**
   - 检查端口是否被占用
   - 检查配置文件是否正确
   - 查看日志文件

2. **数据库连接失败**
   - 检查数据库服务是否运行
   - 检查连接参数是否正确
   - 检查防火墙设置

3. **AI服务调用失败**
   - 检查API密钥是否有效
   - 检查网络连接
   - 查看AI服务日志

## 更新部署

### 1. 后端更新
```bash
cd backend
git pull
go build -o app cmd/main.go
systemctl restart onetaste-backend
```

### 2. 前端更新
```bash
cd frontend/admin
git pull
npm install
npm run build
# 重新部署dist目录
```

### 3. Docker更新
```bash
docker-compose pull
docker-compose up -d
```

## 回滚方案

1. 保留上一个版本的代码和配置
2. 数据库迁移支持回滚
3. 使用版本标签管理Docker镜像
4. 保留备份数据以便快速恢复

