# 数据库设计文档

## 数据库选择
使用 PostgreSQL 14+

## 主键与ID策略

- 所有业务表的`id`及其关联外键均采用`CHAR(26)`类型，存储ULID字符串。
- ULID由应用层（Go服务）在写入数据库前生成，数据库不再使用自增序列，方便未来分库分表及跨库合并。
- 关联关系字段（如`user_id`、`family_id`、`dish_id`等）全部与主键保持相同的数据类型，确保跨表连接时不发生类型转换。

## 表结构设计

### 1. 用户表 (users)

```sql
CREATE TABLE users (
    id CHAR(26) PRIMARY KEY,
    phone VARCHAR(20) UNIQUE NOT NULL,
    password VARCHAR(255) NOT NULL,
    nickname VARCHAR(50),
    avatar VARCHAR(500),
    status SMALLINT DEFAULT 1,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

COMMENT ON TABLE users IS '用户表';
COMMENT ON COLUMN users.phone IS '手机号';
COMMENT ON COLUMN users.password IS '密码（加密）';
COMMENT ON COLUMN users.nickname IS '昵称';
COMMENT ON COLUMN users.avatar IS '头像URL';
COMMENT ON COLUMN users.status IS '状态：1-正常，0-禁用';

CREATE INDEX idx_phone ON users(phone);
CREATE INDEX idx_status ON users(status);

-- 创建更新时间触发器
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ language 'plpgsql';

CREATE TRIGGER update_users_updated_at BEFORE UPDATE ON users
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
```

### 2. 家庭表 (families)

```sql
CREATE TABLE families (
    id CHAR(26) PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    owner_id CHAR(26) NOT NULL,
    max_dishes INT DEFAULT 30,
    status SMALLINT DEFAULT 1,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

COMMENT ON TABLE families IS '家庭表';
COMMENT ON COLUMN families.name IS '家庭名称';
COMMENT ON COLUMN families.description IS '家庭描述';
COMMENT ON COLUMN families.owner_id IS '创建人ID';
COMMENT ON COLUMN families.max_dishes IS '最大菜式数量';
COMMENT ON COLUMN families.status IS '状态：1-正常，0-解散';

CREATE INDEX idx_owner_id ON families(owner_id);
CREATE INDEX idx_status ON families(status);

CREATE TRIGGER update_families_updated_at BEFORE UPDATE ON families
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
```

### 3. 家庭成员表 (family_members)

```sql
CREATE TABLE family_members (
    id CHAR(26) PRIMARY KEY,
    family_id CHAR(26) NOT NULL,
    user_id CHAR(26) NOT NULL,
    role VARCHAR(20) DEFAULT 'member',
    status SMALLINT DEFAULT 1,
    joined_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE (family_id, user_id)
);

COMMENT ON TABLE family_members IS '家庭成员表';
COMMENT ON COLUMN family_members.family_id IS '家庭ID';
COMMENT ON COLUMN family_members.user_id IS '用户ID';
COMMENT ON COLUMN family_members.role IS '角色：owner-创建人，member-成员';
COMMENT ON COLUMN family_members.status IS '状态：1-正常，0-已退出';
COMMENT ON COLUMN family_members.joined_at IS '加入时间';

CREATE INDEX idx_family_id ON family_members(family_id);
CREATE INDEX idx_user_id ON family_members(user_id);

CREATE TRIGGER update_family_members_updated_at BEFORE UPDATE ON family_members
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
```

### 4. 菜式表 (dishes)

```sql
CREATE TABLE dishes (
    id CHAR(26) PRIMARY KEY,
    family_id CHAR(26) NOT NULL,
    name VARCHAR(100) NOT NULL,
    category VARCHAR(50),
    description TEXT,
    image_url VARCHAR(500),
    created_by CHAR(26) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP NULL
);

COMMENT ON TABLE dishes IS '菜式表';
COMMENT ON COLUMN dishes.family_id IS '家庭ID';
COMMENT ON COLUMN dishes.name IS '菜式名称';
COMMENT ON COLUMN dishes.category IS '分类：肉类、蔬菜、汤类等';
COMMENT ON COLUMN dishes.description IS '菜式描述';
COMMENT ON COLUMN dishes.image_url IS '图片URL';
COMMENT ON COLUMN dishes.created_by IS '创建人ID';
COMMENT ON COLUMN dishes.deleted_at IS '软删除时间';

CREATE INDEX idx_family_id ON dishes(family_id);
CREATE INDEX idx_category ON dishes(category);
CREATE INDEX idx_created_by ON dishes(created_by);

CREATE TRIGGER update_dishes_updated_at BEFORE UPDATE ON dishes
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
```

### 5. 食材基础表 (ingredients)

```sql
CREATE TABLE ingredients (
    id CHAR(26) PRIMARY KEY,
    name VARCHAR(100) UNIQUE NOT NULL,
    name_en VARCHAR(150),
    category VARCHAR(50),
    default_unit VARCHAR(20),
    default_amount DECIMAL(10,2),
    storage_days INT,
    description TEXT,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

COMMENT ON TABLE ingredients IS '食材基础表';
COMMENT ON COLUMN ingredients.name IS '标准食材名称';
COMMENT ON COLUMN ingredients.name_en IS '英文/拼音名称，便于搜索';
COMMENT ON COLUMN ingredients.category IS '食材分类：蔬菜、肉类、调料等';
COMMENT ON COLUMN ingredients.default_unit IS '推荐单位';
COMMENT ON COLUMN ingredients.default_amount IS '常用份量';
COMMENT ON COLUMN ingredients.storage_days IS '建议存放天数';
COMMENT ON COLUMN ingredients.description IS '备注说明';
COMMENT ON COLUMN ingredients.is_active IS '是否可用';

CREATE INDEX idx_ingredients_category ON ingredients(category);
CREATE INDEX idx_ingredients_is_active ON ingredients(is_active);
CREATE TRIGGER update_ingredients_updated_at BEFORE UPDATE ON ingredients
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
```

### 6. 菜式食材表 (dish_ingredients)

```sql
CREATE TABLE dish_ingredients (
    id CHAR(26) PRIMARY KEY,
    dish_id CHAR(26) NOT NULL,
    ingredient_id CHAR(26) NOT NULL,
    amount DECIMAL(10,2) NOT NULL,
    unit VARCHAR(20) NOT NULL,
    notes VARCHAR(255),
    sort_order INT DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE (dish_id, ingredient_id, unit)
);

COMMENT ON TABLE dish_ingredients IS '菜式食材明细表';
COMMENT ON COLUMN dish_ingredients.dish_id IS '菜式ID';
COMMENT ON COLUMN dish_ingredients.ingredient_id IS '基础食材ID';
COMMENT ON COLUMN dish_ingredients.amount IS '数量';
COMMENT ON COLUMN dish_ingredients.unit IS '单位：g、kg、个、勺等';
COMMENT ON COLUMN dish_ingredients.notes IS '补充说明';
COMMENT ON COLUMN dish_ingredients.sort_order IS '排序';

CREATE INDEX idx_dish_ingredients_dish_id ON dish_ingredients(dish_id);
CREATE INDEX idx_dish_ingredients_ingredient_id ON dish_ingredients(ingredient_id);
```

### 7. 烹饪步骤表 (cooking_steps)

```sql
CREATE TABLE cooking_steps (
    id CHAR(26) PRIMARY KEY,
    dish_id CHAR(26) NOT NULL,
    step_order INT NOT NULL,
    content TEXT NOT NULL,
    image_url VARCHAR(500),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

COMMENT ON TABLE cooking_steps IS '烹饪步骤表';
COMMENT ON COLUMN cooking_steps.dish_id IS '菜式ID';
COMMENT ON COLUMN cooking_steps.step_order IS '步骤序号';
COMMENT ON COLUMN cooking_steps.content IS '步骤内容';
COMMENT ON COLUMN cooking_steps.image_url IS '步骤图片';

CREATE INDEX idx_dish_id ON cooking_steps(dish_id);
CREATE INDEX idx_step_order ON cooking_steps(dish_id, step_order);
```

### 8. 菜单表 (menus)

```sql
CREATE TABLE menus (
    id CHAR(26) PRIMARY KEY,
    family_id CHAR(26) NOT NULL,
    date DATE NOT NULL,
    meal_type VARCHAR(20) NOT NULL,
    created_by CHAR(26) NOT NULL,
    source VARCHAR(20) DEFAULT 'manual',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

COMMENT ON TABLE menus IS '菜单表';
COMMENT ON COLUMN menus.family_id IS '家庭ID';
COMMENT ON COLUMN menus.date IS '日期';
COMMENT ON COLUMN menus.meal_type IS '餐次：breakfast-早餐，lunch-午餐，dinner-晚餐';
COMMENT ON COLUMN menus.created_by IS '创建人ID';
COMMENT ON COLUMN menus.source IS '来源：manual-手动，ai-AI生成';

CREATE INDEX idx_family_date ON menus(family_id, date);
CREATE INDEX idx_meal_type ON menus(meal_type);
CREATE INDEX idx_created_by ON menus(created_by);

CREATE TRIGGER update_menus_updated_at BEFORE UPDATE ON menus
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
```

### 9. 菜单菜式关联表 (menu_dishes)

```sql
CREATE TABLE menu_dishes (
    id CHAR(26) PRIMARY KEY,
    menu_id CHAR(26) NOT NULL,
    dish_id CHAR(26) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE (menu_id, dish_id)
);

COMMENT ON TABLE menu_dishes IS '菜单菜式关联表';
COMMENT ON COLUMN menu_dishes.menu_id IS '菜单ID';
COMMENT ON COLUMN menu_dishes.dish_id IS '菜式ID';

CREATE INDEX idx_menu_id ON menu_dishes(menu_id);
CREATE INDEX idx_dish_id ON menu_dishes(dish_id);
```

### 10. 购物清单表 (shopping_lists)

```sql
CREATE TABLE shopping_lists (
    id CHAR(26) PRIMARY KEY,
    family_id CHAR(26) NOT NULL,
    name VARCHAR(100),
    start_date DATE,
    end_date DATE,
    status VARCHAR(20) DEFAULT 'pending',
    created_by CHAR(26) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

COMMENT ON TABLE shopping_lists IS '购物清单表';
COMMENT ON COLUMN shopping_lists.family_id IS '家庭ID';
COMMENT ON COLUMN shopping_lists.name IS '清单名称';
COMMENT ON COLUMN shopping_lists.start_date IS '开始日期';
COMMENT ON COLUMN shopping_lists.end_date IS '结束日期';
COMMENT ON COLUMN shopping_lists.status IS '状态：pending-待购买，completed-已完成';
COMMENT ON COLUMN shopping_lists.created_by IS '创建人ID';

CREATE INDEX idx_family_id ON shopping_lists(family_id);
CREATE INDEX idx_status ON shopping_lists(status);

CREATE TRIGGER update_shopping_lists_updated_at BEFORE UPDATE ON shopping_lists
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
```

### 11. 购物清单项表 (shopping_list_items)

```sql
CREATE TABLE shopping_list_items (
    id CHAR(26) PRIMARY KEY,
    list_id CHAR(26) NOT NULL,
    ingredient_name VARCHAR(100) NOT NULL,
    total_amount DECIMAL(10,2) NOT NULL,
    unit VARCHAR(20) NOT NULL,
    category VARCHAR(50),
    status VARCHAR(20) DEFAULT 'pending',
    sort_order INT DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

COMMENT ON TABLE shopping_list_items IS '购物清单项表';
COMMENT ON COLUMN shopping_list_items.list_id IS '清单ID';
COMMENT ON COLUMN shopping_list_items.ingredient_name IS '食材名称';
COMMENT ON COLUMN shopping_list_items.total_amount IS '总数量';
COMMENT ON COLUMN shopping_list_items.unit IS '单位';
COMMENT ON COLUMN shopping_list_items.category IS '食材分类';
COMMENT ON COLUMN shopping_list_items.status IS '状态：pending-待购买，purchased-已购买';
COMMENT ON COLUMN shopping_list_items.sort_order IS '排序';

CREATE INDEX idx_list_id ON shopping_list_items(list_id);
CREATE INDEX idx_status ON shopping_list_items(status);
CREATE INDEX idx_category ON shopping_list_items(category);

CREATE TRIGGER update_shopping_list_items_updated_at BEFORE UPDATE ON shopping_list_items
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
```

### 12. 身体状况记录表 (health_records)

```sql
CREATE TABLE health_records (
    id CHAR(26) PRIMARY KEY,
    user_id CHAR(26) NOT NULL,
    family_id CHAR(26) NOT NULL,
    diseases TEXT,
    work_status VARCHAR(50),
    stress_level VARCHAR(20),
    body_feelings TEXT,
    raw_data TEXT,
    analysis_result TEXT,
    recommendations TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

COMMENT ON TABLE health_records IS '身体状况记录表';
COMMENT ON COLUMN health_records.user_id IS '用户ID';
COMMENT ON COLUMN health_records.family_id IS '家庭ID';
COMMENT ON COLUMN health_records.diseases IS '疾病信息（JSON数组）';
COMMENT ON COLUMN health_records.work_status IS '工作状态';
COMMENT ON COLUMN health_records.stress_level IS '压力水平：低、中、高';
COMMENT ON COLUMN health_records.body_feelings IS '身体感觉描述';
COMMENT ON COLUMN health_records.raw_data IS '原始录入数据';
COMMENT ON COLUMN health_records.analysis_result IS 'AI分析结果';
COMMENT ON COLUMN health_records.recommendations IS '建议（JSON数组）';

CREATE INDEX idx_user_id ON health_records(user_id);
CREATE INDEX idx_family_id ON health_records(family_id);
CREATE INDEX idx_created_at ON health_records(created_at);
```

### 13. 会员表 (memberships)

```sql
CREATE TABLE memberships (
    id CHAR(26) PRIMARY KEY,
    user_id CHAR(26) NOT NULL,
    family_id CHAR(26) NOT NULL,
    plan_type VARCHAR(20) NOT NULL,
    status VARCHAR(20) DEFAULT 'active',
    started_at TIMESTAMP NOT NULL,
    expires_at TIMESTAMP NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

COMMENT ON TABLE memberships IS '会员表';
COMMENT ON COLUMN memberships.user_id IS '用户ID';
COMMENT ON COLUMN memberships.family_id IS '家庭ID';
COMMENT ON COLUMN memberships.plan_type IS '套餐类型：monthly-月付，yearly-年付';
COMMENT ON COLUMN memberships.status IS '状态：active-有效，expired-已过期，cancelled-已取消';
COMMENT ON COLUMN memberships.started_at IS '开始时间';
COMMENT ON COLUMN memberships.expires_at IS '到期时间';

CREATE INDEX idx_user_id ON memberships(user_id);
CREATE INDEX idx_family_id ON memberships(family_id);
CREATE INDEX idx_status ON memberships(status);
CREATE INDEX idx_expires_at ON memberships(expires_at);

CREATE TRIGGER update_memberships_updated_at BEFORE UPDATE ON memberships
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
```

### 14. AI调用记录表 (ai_usage_logs)

```sql
CREATE TABLE ai_usage_logs (
    id CHAR(26) PRIMARY KEY,
    user_id CHAR(26) NOT NULL,
    family_id CHAR(26) NOT NULL,
    feature_type VARCHAR(50) NOT NULL,
    period_type VARCHAR(20) NOT NULL,
    period_date DATE NOT NULL,
    usage_count INT DEFAULT 0,
    limit_count INT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE (user_id, feature_type, period_type, period_date)
);

COMMENT ON TABLE ai_usage_logs IS 'AI调用记录表';
COMMENT ON COLUMN ai_usage_logs.user_id IS '用户ID';
COMMENT ON COLUMN ai_usage_logs.family_id IS '家庭ID';
COMMENT ON COLUMN ai_usage_logs.feature_type IS '功能类型：voice_input, health_analyze, menu_generate, menu_analyze, cooking_optimize';
COMMENT ON COLUMN ai_usage_logs.period_type IS '周期类型：daily, weekly';
COMMENT ON COLUMN ai_usage_logs.period_date IS '周期日期';
COMMENT ON COLUMN ai_usage_logs.usage_count IS '使用次数';
COMMENT ON COLUMN ai_usage_logs.limit_count IS '限制次数';

CREATE INDEX idx_family_id ON ai_usage_logs(family_id);
CREATE INDEX idx_period_date ON ai_usage_logs(period_date);

CREATE TRIGGER update_ai_usage_logs_updated_at BEFORE UPDATE ON ai_usage_logs
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
```

### 15. 支付订单表 (payment_orders)

```sql
CREATE TABLE payment_orders (
    id CHAR(26) PRIMARY KEY,
    order_no VARCHAR(50) UNIQUE NOT NULL,
    user_id CHAR(26) NOT NULL,
    family_id CHAR(26) NOT NULL,
    plan_type VARCHAR(20) NOT NULL,
    amount DECIMAL(10,2) NOT NULL,
    payment_method VARCHAR(20),
    status VARCHAR(20) DEFAULT 'pending',
    paid_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

COMMENT ON TABLE payment_orders IS '支付订单表';
COMMENT ON COLUMN payment_orders.order_no IS '订单号';
COMMENT ON COLUMN payment_orders.user_id IS '用户ID';
COMMENT ON COLUMN payment_orders.family_id IS '家庭ID';
COMMENT ON COLUMN payment_orders.plan_type IS '套餐类型';
COMMENT ON COLUMN payment_orders.amount IS '金额';
COMMENT ON COLUMN payment_orders.payment_method IS '支付方式：wechat, alipay';
COMMENT ON COLUMN payment_orders.status IS '状态：pending-待支付，paid-已支付，failed-失败，refunded-已退款';
COMMENT ON COLUMN payment_orders.paid_at IS '支付时间';

CREATE INDEX idx_user_id ON payment_orders(user_id);
CREATE INDEX idx_order_no ON payment_orders(order_no);
CREATE INDEX idx_status ON payment_orders(status);

CREATE TRIGGER update_payment_orders_updated_at BEFORE UPDATE ON payment_orders
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
```

### 16. 系统配置表 (system_configs)

```sql
CREATE TABLE system_configs (
    id CHAR(26) PRIMARY KEY,
    config_key VARCHAR(100) UNIQUE NOT NULL,
    config_value TEXT,
    description VARCHAR(500),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

COMMENT ON TABLE system_configs IS '系统配置表';
COMMENT ON COLUMN system_configs.config_key IS '配置键';
COMMENT ON COLUMN system_configs.config_value IS '配置值';
COMMENT ON COLUMN system_configs.description IS '描述';

CREATE TRIGGER update_system_configs_updated_at BEFORE UPDATE ON system_configs
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
```

## 索引优化建议

1. **用户查询优化**：users表的phone字段已建立唯一索引
2. **家庭查询优化**：family_members表建立联合索引(family_id, user_id)
3. **菜单查询优化**：menus表建立联合索引(family_id, date)
4. **AI调用记录优化**：ai_usage_logs表建立联合唯一索引，避免重复记录

## 数据关系图

```
users (1) ----< (N) family_members (N) >---- (1) families
families (1) ----< (N) dishes
dishes (1) ----< (N) dish_ingredients >---- (1) ingredients
dishes (1) ----< (N) cooking_steps
families (1) ----< (N) menus
menus (N) >----< (N) dishes (menu_dishes)
families (1) ----< (N) shopping_lists
shopping_lists (1) ----< (N) shopping_list_items
users (1) ----< (N) health_records
users (1) ----< (N) memberships
users (1) ----< (N) ai_usage_logs
users (1) ----< (N) payment_orders
```

## 数据迁移脚本

建议使用数据库迁移工具管理数据库版本：
- **Go项目**：golang-migrate (https://github.com/golang-migrate/migrate)
- **Python项目**：Alembic (https://alembic.sqlalchemy.org/)

### 使用golang-migrate示例
```bash
# 创建迁移文件
migrate create -ext sql -dir migrations -seq create_users_table

# 执行迁移
migrate -path ./migrations -database "postgres://user:password@localhost:5432/onetaste_family?sslmode=disable" up

# 回滚
migrate -path ./migrations -database "postgres://user:password@localhost:5432/onetaste_family?sslmode=disable" down
```

## 备份策略

### PostgreSQL备份命令

1. **全量备份**：每天凌晨执行一次全量备份
```bash
pg_dump -U username -d onetaste_family -F c -f /backup/db_$(date +\%Y\%m\%d).dump
```

2. **增量备份**：使用WAL归档（Write-Ahead Logging）
```bash
# 在postgresql.conf中启用WAL归档
wal_level = replica
archive_mode = on
archive_command = 'cp %p /backup/wal_archive/%f'
```

3. **恢复备份**
```bash
pg_restore -U username -d onetaste_family -F c /backup/db_20240115.dump
```

4. **备份保留**：全量备份保留30天，WAL归档保留7天
