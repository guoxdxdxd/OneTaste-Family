# API 接口文档

## 基础信息

### 基础URL
```
开发环境：http://localhost:8080/api/v1
生产环境：https://api.onetastefamily.com/api/v1
```

### 认证方式
使用JWT Token认证，在请求头中携带：
```
Authorization: Bearer {token}
```

### 响应格式
```json
{
  "code": 200,
  "message": "success",
  "data": {}
}
```

### 错误码说明
- 200: 成功
- 400: 请求参数错误
- 401: 未授权
- 403: 无权限
- 404: 资源不存在
- 500: 服务器错误

---

## 用户认证

### 用户注册
```
POST /auth/register
```

**请求参数：**
```json
{
  "phone": "13800138000",
  "password": "password123",
  "verify_code": "123456",
  "nickname": "张三"
}
```

**响应：**
```json
{
  "code": 200,
  "message": "注册成功",
  "data": {
    "user_id": 1,
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
  }
}
```

### 用户登录
```
POST /auth/login
```

**请求参数：**
```json
{
  "phone": "13800138000",
  "password": "password123"
}
```

**响应：**
```json
{
  "code": 200,
  "message": "登录成功",
  "data": {
    "user_id": 1,
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "expires_in": 7200
  }
}
```

### 获取用户信息
```
GET /user/info
```

**响应：**
```json
{
  "code": 200,
  "data": {
    "user_id": 1,
    "phone": "13800138000",
    "nickname": "张三",
    "avatar": "https://...",
    "membership": {
      "type": "free",
      "expires_at": null
    }
  }
}
```

---

## 家庭管理

### 创建家庭
```
POST /family/create
```

**请求参数：**
```json
{
  "name": "张家的厨房",
  "description": "温馨的家庭"
}
```

**响应：**
```json
{
  "code": 200,
  "data": {
    "family_id": 1,
    "name": "张家的厨房",
    "member_count": 1
  }
}
```

### 获取家庭信息
```
GET /family/info
```

**响应：**
```json
{
  "code": 200,
  "data": {
    "family_id": 1,
    "name": "张家的厨房",
    "member_count": 3,
    "dish_count": 15,
    "max_dishes": 30
  }
}
```

### 邀请家庭成员（扫码同意后加入）
```
POST /family/member/invite
```

**说明：**  
家庭成员在前端扫码并登录后，点击“同意”按钮会调用该接口，后端根据URL中携带的邀请信息完成入群。

**请求参数：**
```json
{
  "family_id": 1,
  "family_name": "张家的厨房",
  "inviter_id": 1001,
  "inviter_nickname": "张三",
  "action": "accept"
}
```

- `action` 目前仅支持 `"accept"`，拒绝不调用接口

**响应：**
```json
{
  "code": 200,
  "message": "加入家庭成功",
  "data": {
    "family_id": 1,
    "member_role": "member",
    "joined_at": "2024-01-01T00:00:00Z"
  }
}
```

### 获取家庭成员列表
```
GET /family/members
```

**响应：**
```json
{
  "code": 200,
  "data": {
    "members": [
      {
        "user_id": 1,
        "nickname": "张三",
        "role": "owner",
        "joined_at": "2024-01-01T00:00:00Z"
      }
    ]
  }
}
```

---

## 食谱管理

### 创建菜式
```
POST /dishes
```

**请求参数：**
```json
{
  "name": "红烧肉",
  "category": "肉类",
  "description": "经典家常菜",
  "ingredients": [
    {
      "ingredient_id": "01HABCDE1234567890ABCDE1",
      "amount": 500,
      "unit": "g",
      "notes": "切成2cm方块"
    },
    {
      "ingredient_id": "01HABCDE1234567890ABCDE2",
      "amount": 2,
      "unit": "勺",
      "notes": "生抽"
    }
  ],
  "steps": [
    {
      "order": 1,
      "content": "将五花肉切块"
    },
    {
      "order": 2,
      "content": "热锅下油，炒糖色"
    }
  ]
}
```

> `ingredients` 数组中的 `ingredient_id` 必须来自基础食材库，后端会根据ID带出标准名称、分类、默认单位等信息。

**响应：**
```json
{
  "code": 200,
  "data": {
    "dish_id": "01HXYZ...",
    "name": "红烧肉",
    "ingredients": [
      {
        "ingredient_id": "01HABCDE1234567890ABCDE1",
        "ingredient_name": "五花肉",
        "category": "肉类",
        "amount": 500,
        "unit": "g",
        "notes": "切成2cm方块"
      }
    ]
  }
}
```

### 获取菜式列表
```
GET /dishes?page=1&page_size=20&category=肉类
```

**响应：**
```json
{
  "code": 200,
  "data": {
    "dishes": [
      {
        "dish_id": 1,
        "name": "红烧肉",
        "category": "肉类",
        "created_at": "2024-01-01T00:00:00Z"
      }
    ],
    "total": 15,
    "page": 1,
    "page_size": 20
  }
}
```

### 获取菜式详情
```
GET /dishes/{id}
```

**响应：**
```json
{
  "code": 200,
  "data": {
    "dish_id": "01HXYZ...",
    "name": "红烧肉",
    "category": "肉类",
    "description": "经典家常菜",
    "ingredients": [
      {
        "id": "01HASSOC...",
        "ingredient_id": "01HABCDE1234567890ABCDE1",
        "ingredient_name": "五花肉",
        "ingredient_name_en": "pork belly",
        "category": "肉类",
        "default_unit": "g",
        "amount": 500,
        "unit": "g",
        "notes": "切成2cm方块",
        "storage_days": 3
      }
    ],
    "steps": [
      {
        "order": 1,
        "content": "将五花肉切块"
      }
    ],
    "created_at": "2024-01-01T00:00:00Z",
    "updated_at": "2024-01-05T10:00:00Z"
  }
}
```

### 更新菜式
```
PUT /dishes/{id}
```

### 删除菜式
```
DELETE /dishes/{id}
```

### 语音输入菜式（付费）
```
POST /dishes/voice-input
```

**请求参数：**
```json
{
  "audio_url": "https://...",
  "audio_format": "mp3"
}
```

**响应：**
```json
{
  "code": 200,
  "data": {
    "dish": {
      "name": "红烧肉",
      "ingredients": [...],
      "steps": [...]
    },
    "remaining_count": 9
  }
}
```

---

## 基础食材库

平台级公共食材库，菜式和购物清单均引用此处的 `ingredient_id`，以便后续自动聚合和统计。

### 查询食材列表
```
GET /ingredients?keyword=肉&page=1&page_size=20&category=meat&status=active
```

**响应：**
```json
{
  "code": 200,
  "data": {
    "items": [
      {
        "ingredient_id": "01HABCDE1234567890ABCDE1",
        "name": "五花肉",
        "name_en": "pork belly",
        "category": "meat",
        "default_unit": "g",
        "default_amount": 300,
        "storage_days": 3,
        "description": "肥瘦相间，红烧必备",
        "is_active": true
      }
    ],
    "page": 1,
    "page_size": 20,
    "total": 200
  }
}
```

### 新增食材
```
POST /ingredients
```

**请求参数：**
```json
{
  "name": "生抽",
  "name_en": "soy sauce",
  "category": "condiment",
  "default_unit": "勺",
  "default_amount": 1,
  "storage_days": 180,
  "description": "海天生抽",
  "is_active": true
}
```

### 更新食材
```
PUT /ingredients/{id}
```

### 启用 / 禁用食材
```
PATCH /ingredients/{id}/status
```

**请求参数：**
```json
{
  "is_active": false
}
```

> 禁用的食材不会在菜式录入候选列表中出现，但历史菜式仍可引用旧数据。

---

## 菜单管理

### 创建菜单
```
POST /menus
```

**请求参数：**
```json
{
  "date": "2024-01-15",
  "meal_type": "dinner",
  "dish_ids": [1, 2, 3]
}
```

**响应：**
```json
{
  "code": 200,
  "data": {
    "menu_id": 1,
    "date": "2024-01-15",
    "meal_type": "dinner",
    "dishes": [...]
  }
}
```

### 获取每日菜单
```
GET /menus/daily?date=2024-01-15
```

**响应：**
```json
{
  "code": 200,
  "data": {
    "date": "2024-01-15",
    "menus": [
      {
        "meal_type": "breakfast",
        "dishes": [...]
      },
      {
        "meal_type": "lunch",
        "dishes": [...]
      },
      {
        "meal_type": "dinner",
        "dishes": [...]
      }
    ]
  }
}
```

### 获取每周菜单
```
GET /menus/weekly?start_date=2024-01-15
```

### AI生成菜单（付费）
```
POST /menus/ai-generate
```

**请求参数：**
```json
{
  "start_date": "2024-01-15",
  "days": 7,
  "user_ids": [1, 2]
}
```

**响应：**
```json
{
  "code": 200,
  "data": {
    "menus": [...],
    "reason": "根据您的身体状况，推荐...",
    "remaining_count": 4
  }
}
```

### AI分析菜单（付费）
```
POST /menus/ai-analyze
```

**请求参数：**
```json
{
  "menu_ids": [1, 2, 3, 4, 5]
}
```

**响应：**
```json
{
  "code": 200,
  "data": {
    "analysis": "您的菜单营养搭配合理...",
    "suggestions": ["建议增加蔬菜...", "减少油腻食物..."],
    "remaining_count": 4
  }
}
```

---

## 购物清单

### 生成购物清单
```
POST /shopping-lists/generate
```

**请求参数：**
```json
{
  "start_date": "2024-01-15",
  "end_date": "2024-01-21",
  "menu_ids": [1, 2, 3]
}
```

> 系统会读取指定菜单中的 `dish_ingredients` 数据，并按照 `ingredient_id + unit` 维度自动合并数量。

**响应：**
```json
{
  "code": 200,
  "data": {
    "list_id": 1,
    "items": [
      {
        "ingredient_id": "01HABCDE1234567890ABCDE1",
        "ingredient_name": "五花肉",
        "category": "肉类",
        "total_amount": 1500,
        "unit": "g",
        "storage_days": 3,
        "pending_amount": 1500,
        "purchased_amount": 0
      }
    ],
    "total_items": 20
  }
}
```

### 获取购物清单
```
GET /shopping-lists/{id}
```

**响应字段补充：**
```json
{
  "code": 200,
  "data": {
    "list_id": 1,
    "family_id": "01HFAM...",
    "status": "pending",
    "items": [
      {
        "item_id": "01HITEM...",
        "ingredient_id": "01HABCDE1234567890ABCDE1",
        "ingredient_name": "五花肉",
        "category": "肉类",
        "total_amount": 1500,
        "unit": "g",
        "storage_days": 3,
        "status": "pending"
      }
    ]
  }
}
```

### 更新购物清单
```
PUT /shopping-lists/{id}
```

**请求参数示例：**
```json
{
  "items": [
    {
      "item_id": "01HITEM...",
      "ingredient_id": "01HABCDE1234567890ABCDE2",
      "total_amount": 2,
      "unit": "瓶",
      "status": "pending"
    }
  ]
}
```

### 切换购物项状态
```
POST /shopping-lists/{id}/items/{itemId}/toggle
```

---

## 身体状况（付费）

### 录入身体状况
```
POST /health/record
```

**请求参数：**
```json
{
  "diseases": ["高血压"],
  "work_status": "很忙",
  "stress_level": "高",
  "body_feelings": "最近有点累，睡眠不好"
}
```

### AI分析身体状况
```
POST /health/analyze
```

**响应：**
```json
{
  "code": 200,
  "data": {
    "analysis": "根据您的身体状况，建议...",
    "recommendations": ["多休息", "清淡饮食"],
    "remaining_count": 1
  }
}
```

### 获取身体状况记录
```
GET /health/records?page=1&page_size=20
```

---

## 烹饪步骤优化（付费）

### AI优化烹饪步骤
```
POST /cooking/optimize
```

**请求参数：**
```json
{
  "dish_ids": [1, 2, 3],
  "meal_type": "dinner"
}
```

**响应：**
```json
{
  "code": 200,
  "data": {
    "optimized_steps": [
      {
        "order": 1,
        "content": "同时准备：切五花肉、洗青菜、准备调料",
        "time": "10分钟"
      },
      {
        "order": 2,
        "content": "先做红烧肉（需要炖煮30分钟）",
        "time": "30分钟"
      }
    ],
    "total_time": "45分钟",
    "efficiency": "比单独做节省15分钟"
  }
}
```

---

## 支付相关

### 订阅会员
```
POST /payment/subscribe
```

**请求参数：**
```json
{
  "plan": "monthly",
  "payment_method": "wechat"
}
```

### 获取会员信息
```
GET /payment/membership
```

**响应：**
```json
{
  "code": 200,
  "data": {
    "type": "premium",
    "expires_at": "2024-02-15T00:00:00Z",
    "features": {
      "max_dishes": 60,
      "ai_voice_input": {
        "daily_limit": 10,
        "remaining": 8
      },
      "ai_health_analyze": {
        "daily_limit": 2,
        "remaining": 1
      },
      "ai_menu_generate": {
        "weekly_limit": 5,
        "remaining": 3
      },
      "ai_menu_analyze": {
        "weekly_limit": 5,
        "remaining": 4
      }
    }
  }
}
```

---

## 错误处理

### 错误响应格式
```json
{
  "code": 400,
  "message": "请求参数错误",
  "errors": [
    {
      "field": "phone",
      "message": "手机号格式不正确"
    }
  ]
}
```

### 常见错误码
- 1001: 手机号已注册
- 1002: 验证码错误
- 1003: 密码错误
- 2001: 家庭不存在
- 2002: 无权限操作
- 3001: 菜式数量已达上限
- 4001: AI调用次数已用完
- 5001: 支付失败
