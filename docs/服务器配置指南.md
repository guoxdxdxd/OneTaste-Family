# Ubuntu 22.04 系统配置指南

本文档专门针对 Ubuntu 22.04 LTS 64位（UEFI）系统，提供详细的系统配置和优化指南。

## 系统信息

- **操作系统**：Ubuntu 22.04 LTS
- **架构**：64位
- **启动方式**：UEFI
- **内核版本**：5.15+

## 1. 系统更新

### 更新软件包列表

```bash
sudo apt update
sudo apt upgrade -y
```

### 安装基础工具

```bash
sudo apt install -y \
    curl \
    wget \
    git \
    vim \
    nano \
    htop \
    net-tools \
    software-properties-common \
    apt-transport-https \
    ca-certificates \
    gnupg \
    lsb-release
```

## 2. 安装 Docker

### 方法一：使用官方仓库（推荐）

```bash
# 1. 卸载旧版本（如果有）
sudo apt remove -y docker docker-engine docker.io containerd runc

# 2. 添加 Docker 官方 GPG 密钥
sudo mkdir -p /etc/apt/keyrings
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg

# 3. 设置仓库
echo \
  "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
  $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

# 4. 更新软件包索引
sudo apt update

# 5. 安装 Docker Engine、CLI 和 Compose 插件
sudo apt install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

# 6. 验证安装
sudo docker --version
sudo docker compose version
```

### 方法二：使用 snap（不推荐，但更简单）

```bash
sudo snap install docker
```

## 3. 配置 Docker

### 将用户添加到 docker 组

```bash
# 添加当前用户到 docker 组
sudo usermod -aG docker $USER

# 重新登录或执行以下命令使组权限生效
newgrp docker

# 验证（不需要 sudo）
docker run hello-world
```

### 配置 Docker 服务自启动

```bash
sudo systemctl enable docker
sudo systemctl start docker
sudo systemctl status docker
```

### 配置 Docker 日志大小

创建或编辑 `/etc/docker/daemon.json`：

```bash
sudo mkdir -p /etc/docker
sudo nano /etc/docker/daemon.json
```

添加以下内容：

```json
{
  "log-driver": "json-file",
  "log-opts": {
    "max-size": "10m",
    "max-file": "3"
  },
  "storage-driver": "overlay2"
}
```

重启 Docker 服务：

```bash
sudo systemctl restart docker
```

## 4. 系统优化

### 优化系统参数

编辑 `/etc/sysctl.conf`：

```bash
sudo nano /etc/sysctl.conf
```

添加以下配置：

```conf
# 网络优化
net.core.somaxconn = 1024
net.ipv4.tcp_max_syn_backlog = 2048
net.ipv4.tcp_fin_timeout = 30
net.ipv4.tcp_keepalive_time = 300
net.ipv4.tcp_tw_reuse = 1

# 内存优化
vm.overcommit_memory = 1
vm.swappiness = 10
vm.dirty_ratio = 60
vm.dirty_background_ratio = 2

# 文件系统优化
fs.file-max = 2097152
```

应用配置：

```bash
sudo sysctl -p
```

### 优化文件描述符限制

编辑 `/etc/security/limits.conf`：

```bash
sudo nano /etc/security/limits.conf
```

添加以下内容：

```conf
* soft nofile 65535
* hard nofile 65535
* soft nproc 65535
* hard nproc 65535
```

重新登录使配置生效。

## 5. 防火墙配置（UFW）

### 安装和配置 UFW

```bash
# 检查 UFW 状态
sudo ufw status

# 如果未启用，启用它
sudo ufw enable

# 允许 SSH（重要！先执行这个，避免被锁在外面）
sudo ufw allow 22/tcp

# 允许 PostgreSQL 和 Redis（仅本地访问）
sudo ufw allow from 127.0.0.1 to any port 5432
sudo ufw allow from 127.0.0.1 to any port 6379

# 如果需要从外部访问（不推荐生产环境）
# sudo ufw allow 5432/tcp
# sudo ufw allow 6379/tcp

# 查看规则
sudo ufw status numbered

# 如果需要删除规则
# sudo ufw delete [规则编号]
```

## 6. 时区配置

```bash
# 查看当前时区
timedatectl

# 设置时区为上海（中国标准时间）
sudo timedatectl set-timezone Asia/Shanghai

# 验证
timedatectl
```

## 7. 自动更新配置（可选）

### 配置自动安全更新

```bash
sudo apt install -y unattended-upgrades

# 配置自动更新
sudo dpkg-reconfigure -plow unattended-upgrades
```

编辑 `/etc/apt/apt.conf.d/50unattended-upgrades`，根据需要调整配置。

## 8. 磁盘空间管理

### 清理系统

```bash
# 清理 apt 缓存
sudo apt clean
sudo apt autoremove -y

# 清理旧的内核版本
sudo apt autoremove --purge

# 清理 Docker（谨慎使用）
docker system prune -a --volumes
```

### 查看磁盘使用情况

```bash
# 查看磁盘使用
df -h

# 查看目录大小
du -sh /* 2>/dev/null | sort -h

# 查找大文件
sudo find / -type f -size +100M -exec ls -lh {} \; 2>/dev/null
```

## 9. 性能监控工具

### 安装监控工具

```bash
sudo apt install -y \
    htop \
    iotop \
    nethogs \
    iftop
```

### 使用 htop 监控

```bash
htop
```

## 10. 网络配置

### 查看网络接口

```bash
ip addr show
# 或
ifconfig
```

### 配置静态 IP（如果需要）

编辑网络配置文件：

```bash
sudo nano /etc/netplan/00-installer-config.yaml
```

示例配置：

```yaml
network:
  version: 2
  renderer: networkd
  ethernets:
    eth0:
      dhcp4: no
      addresses:
        - 192.168.1.100/24
      gateway4: 192.168.1.1
      nameservers:
        addresses:
          - 8.8.8.8
          - 8.8.4.4
```

应用配置：

```bash
sudo netplan apply
```

## 11. SSH 配置（如果使用远程访问）

### 安装 OpenSSH Server

```bash
sudo apt install -y openssh-server
sudo systemctl enable ssh
sudo systemctl start ssh
```

### 安全配置 SSH

编辑 `/etc/ssh/sshd_config`：

```bash
sudo nano /etc/ssh/sshd_config
```

建议的配置：

```conf
# 禁用 root 登录
PermitRootLogin no

# 使用密钥认证（更安全）
PasswordAuthentication yes  # 如果使用密码，保持 yes
# PubkeyAuthentication yes  # 如果使用密钥，启用这个

# 更改默认端口（可选）
# Port 2222
```

重启 SSH 服务：

```bash
sudo systemctl restart sshd
```

## 12. 系统备份

### 创建备份脚本

创建 `/usr/local/bin/system-backup.sh`：

```bash
sudo nano /usr/local/bin/system-backup.sh
```

```bash
#!/bin/bash
BACKUP_DIR="/backup/system"
DATE=$(date +%Y%m%d_%H%M%S)

mkdir -p ${BACKUP_DIR}

# 备份重要配置文件
tar -czf ${BACKUP_DIR}/etc_backup_${DATE}.tar.gz /etc

# 备份用户数据（根据实际情况调整）
# tar -czf ${BACKUP_DIR}/home_backup_${DATE}.tar.gz /home

echo "Backup completed: ${BACKUP_DIR}/etc_backup_${DATE}.tar.gz"
```

设置执行权限：

```bash
sudo chmod +x /usr/local/bin/system-backup.sh
```

添加到 crontab（每周日凌晨 2 点执行）：

```bash
sudo crontab -e
```

添加：

```
0 2 * * 0 /usr/local/bin/system-backup.sh
```

## 13. 常用命令速查

```bash
# 系统信息
uname -a                    # 内核信息
lsb_release -a              # 发行版信息
free -h                     # 内存使用
df -h                       # 磁盘使用
uptime                      # 系统运行时间

# 进程管理
ps aux                      # 查看所有进程
top                         # 实时进程监控
htop                        # 增强版 top
kill -9 [PID]               # 强制结束进程

# 网络
ip addr show                # 查看 IP 地址
ss -tuln                    # 查看端口监听
netstat -tuln               # 查看端口（需要 net-tools）
ping [host]                 # 测试网络连接

# 服务管理
sudo systemctl status [service]    # 查看服务状态
sudo systemctl start [service]     # 启动服务
sudo systemctl stop [service]       # 停止服务
sudo systemctl restart [service]    # 重启服务
sudo systemctl enable [service]     # 设置开机自启

# Docker
docker ps                   # 查看运行中的容器
docker ps -a                # 查看所有容器
docker images               # 查看镜像
docker logs [container]     # 查看容器日志
docker stats                # 查看容器资源使用
```

## 14. 故障排查

### 查看系统日志

```bash
# 查看系统日志
sudo journalctl -xe

# 查看特定服务的日志
sudo journalctl -u docker -f

# 查看最近的错误
sudo journalctl -p err -b
```

### 查看内核日志

```bash
dmesg | tail -50
```

### 检查磁盘健康

```bash
# 安装 smartmontools
sudo apt install -y smartmontools

# 检查磁盘健康
sudo smartctl -a /dev/sda
```

## 15. 安全建议

1. **定期更新系统**
   ```bash
   sudo apt update && sudo apt upgrade -y
   ```

2. **使用强密码**
   - 至少 12 个字符
   - 包含大小写字母、数字和特殊字符

3. **配置防火墙**
   - 只开放必要的端口
   - 限制访问来源

4. **定期备份**
   - 系统配置
   - 应用数据
   - 数据库

5. **监控系统**
   - 定期检查日志
   - 监控资源使用
   - 设置告警

## 相关文档

- [Docker 部署文档](./DOCKER_DEPLOYMENT.md)
- [部署文档](./DEPLOYMENT.md)

